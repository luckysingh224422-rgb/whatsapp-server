<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Bulk Sender</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .card { background: #f8f9fa; padding: 20px; margin: 10px 0; border-radius: 8px; border: 1px solid #ddd; }
        input, select, button { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px; }
        button { background: #25D366; color: white; border: none; cursor: pointer; }
        button:hover { background: #128C7E; }
        .stop-btn { background: #dc3545; }
        .stop-btn:hover { background: #c82333; }
        .task-id { background: #2d3748; color: white; padding: 10px; border-radius: 5px; font-family: monospace; margin: 10px 0; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #cce7ff; color: #004085; }
    </style>
</head>
<body>
    <div class="container">
        <h1>WhatsApp Bulk Sender</h1>
        
        <!-- Session Management -->
        <div class="card">
            <h2>1. Setup Session</h2>
            <input type="text" id="ownerId" placeholder="Owner ID" value="user1">
            <input type="text" id="number" placeholder="WhatsApp Number (e.g., 919876543210)">
            <button onclick="requestPairingCode()">Get Pairing Code</button>
            <div id="pairingResult" class="status"></div>
        </div>

        <!-- Send Messages -->
        <div class="card">
            <h2>2. Send Messages</h2>
            <select id="sessionSelect">
                <option value="">-- Select Session --</option>
            </select>
            <input type="text" id="target" placeholder="Target Number/Group">
            <select id="targetType">
                <option value="individual">Individual</option>
                <option value="group">Group</option>
            </select>
            <input type="file" id="messageFile" accept=".txt">
            <small>Text file with one message per line</small>
            <input type="text" id="prefix" placeholder="Message Prefix (Optional)">
            <input type="number" id="delaySec" value="2" placeholder="Delay in seconds">
            <button onclick="startSending()">Start Sending</button>
            <div id="taskResult" class="status"></div>
        </div>

        <!-- Stop Task -->
        <div class="card">
            <h2>3. Stop Task</h2>
            <input type="text" id="stopTaskId" placeholder="Enter Task ID to stop">
            <button onclick="stopTask()" class="stop-btn">Stop This Task</button>
            <button onclick="stopAllTasks()" class="stop-btn">Stop All Tasks</button>
            <div id="stopResult" class="status"></div>
        </div>

        <!-- Task Status -->
        <div class="card">
            <h2>4. Check Status</h2>
            <input type="text" id="statusTaskId" placeholder="Enter Task ID to check status">
            <button onclick="checkTaskStatus()">Check Status</button>
            <button onclick="listAllTasks()">List All Tasks</button>
            <div id="statusResult" class="status"></div>
        </div>
    </div>

    <script>
        // Simple functions
        async function requestPairingCode() {
            const number = document.getElementById('number').value;
            const ownerId = document.getElementById('ownerId').value;
            
            if (!number) {
                showResult('pairingResult', 'Please enter WhatsApp number', 'error');
                return;
            }

            try {
                const response = await fetch(`/code?number=${number}&ownerId=${ownerId}`);
                const result = await response.json();
                
                if (response.ok) {
                    showResult('pairingResult', 
                        `Pairing Code: ${result.pairingCode}<br>Status: ${result.message}`, 
                        'success'
                    );
                    refreshSessions();
                } else {
                    showResult('pairingResult', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showResult('pairingResult', 'Error: ' + error.message, 'error');
            }
        }

        async function startSending() {
            const sessionId = document.getElementById('sessionSelect').value;
            const target = document.getElementById('target').value;
            const fileInput = document.getElementById('messageFile');
            
            if (!sessionId || !target || !fileInput.files[0]) {
                showResult('taskResult', 'Please fill all fields and select file', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('sessionId', sessionId);
            formData.append('target', target);
            formData.append('targetType', document.getElementById('targetType').value);
            formData.append('delaySec', document.getElementById('delaySec').value);
            formData.append('prefix', document.getElementById('prefix').value);
            formData.append('ownerId', document.getElementById('ownerId').value);
            formData.append('messageFile', fileInput.files[0]);

            try {
                const response = await fetch('/send-message', { method: 'POST', body: formData });
                const result = await response.json();
                
                if (response.ok) {
                    showResult('taskResult', 
                        `✅ Task Started!<br>Task ID: <strong>${result.taskId}</strong><br>${result.message}`, 
                        'success'
                    );
                    document.getElementById('stopTaskId').value = result.taskId;
                } else {
                    showResult('taskResult', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showResult('taskResult', 'Error: ' + error.message, 'error');
            }
        }

        async function stopTask() {
            const taskId = document.getElementById('stopTaskId').value;
            
            if (!taskId) {
                showResult('stopResult', 'Please enter Task ID', 'error');
                return;
            }

            try {
                const response = await fetch('/stop-task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `taskId=${taskId}`
                });
                const result = await response.json();
                
                if (response.ok) {
                    showResult('stopResult', 
                        `✅ Task Stopped!<br>Task ID: ${result.taskId}<br>Progress: ${result.sentMessages}/${result.totalMessages} messages`, 
                        'success'
                    );
                } else {
                    showResult('stopResult', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showResult('stopResult', 'Error: ' + error.message, 'error');
            }
        }

        async function stopAllTasks() {
            try {
                const response = await fetch('/tasks');
                const result = await response.json();
                
                if (result.activeTasks.length === 0) {
                    showResult('stopResult', 'No active tasks found', 'info');
                    return;
                }

                let stopped = 0;
                for (const task of result.activeTasks) {
                    if (task.isSending) {
                        await fetch('/stop-task', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: `taskId=${task.taskId}`
                        });
                        stopped++;
                    }
                }
                
                showResult('stopResult', `Stopped ${stopped} tasks`, 'success');
            } catch (error) {
                showResult('stopResult', 'Error: ' + error.message, 'error');
            }
        }

        async function checkTaskStatus() {
            const taskId = document.getElementById('statusTaskId').value;
            
            if (!taskId) {
                showResult('statusResult', 'Please enter Task ID', 'error');
                return;
            }

            try {
                const response = await fetch(`/task-status?taskId=${taskId}`);
                const result = await response.json();
                
                if (response.ok) {
                    showResult('statusResult', 
                        `Task ID: ${result.taskId}<br>Status: ${result.status}<br>Progress: ${result.sentMessages}/${result.totalMessages} (${result.progress}%)<br>Start Time: ${new Date(result.startTime).toLocaleString()}`, 
                        'info'
                    );
                } else {
                    showResult('statusResult', 'Error: ' + result.error, 'error');
                }
            } catch (error) {
                showResult('statusResult', 'Error: ' + error.message, 'error');
            }
        }

        async function listAllTasks() {
            try {
                const response = await fetch('/tasks');
                const result = await response.json();
                
                if (result.activeTasks.length === 0) {
                    showResult('statusResult', 'No active tasks', 'info');
                    return;
                }

                let html = `<strong>Active Tasks (${result.total}):</strong><br>`;
                result.activeTasks.forEach(task => {
                    html += `Task: ${task.taskId} | Status: ${task.isSending ? 'Sending' : 'Stopped'} | Progress: ${task.sentMessages}/${task.totalMessages}<br>`;
                });
                
                showResult('statusResult', html, 'info');
            } catch (error) {
                showResult('statusResult', 'Error: ' + error.message, 'error');
            }
        }

        async function refreshSessions() {
            try {
                const response = await fetch('/status');
                const data = await response.json();
                
                const select = document.getElementById('sessionSelect');
                select.innerHTML = '<option value="">-- Select Session --</option>';
                
                data.activeSessions.forEach(session => {
                    const option = document.createElement('option');
                    option.value = session.sessionId;
                    option.textContent = `${session.number} (${session.registered ? 'Connected' : 'Pending'})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error refreshing sessions:', error);
            }
        }

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = `status ${type}`;
        }

        // Initial load
        refreshSessions();
    </script>
</body>
</html>
